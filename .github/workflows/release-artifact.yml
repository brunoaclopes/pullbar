name: Release Artifact

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.2.3)"
        required: true
        type: string
      target_commitish:
        description: "Branch or commit SHA to tag/release"
        required: false
        default: "main"
        type: string
      release_name:
        description: "Release title (optional)"
        required: false
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        default: false
        type: boolean
      draft:
        description: "Create as draft"
        required: false
        default: false
        type: boolean
      release_notes:
        description: "Custom release notes (optional)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-release-artifact:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release binary
        run: swift build -c release

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            tag="${{ inputs.tag }}"
            target="${{ inputs.target_commitish }}"
            if [[ -n "${{ inputs.release_name }}" ]]; then
              title="${{ inputs.release_name }}"
            else
              title="Pullbar ${tag}"
            fi
            prerelease="${{ inputs.prerelease }}"
            draft="${{ inputs.draft }}"
          else
            tag="${GITHUB_REF_NAME}"
            target="${GITHUB_SHA}"
            title="Pullbar ${tag}"
            prerelease="false"
            draft="false"
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "target=${target}" >> "$GITHUB_OUTPUT"
          echo "title=${title}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${prerelease}" >> "$GITHUB_OUTPUT"
          echo "draft=${draft}" >> "$GITHUB_OUTPUT"

      - name: Bundle Pullbar.app
        shell: bash
        run: |
          set -euo pipefail

          APP_NAME="Pullbar.app"
          EXECUTABLE="Pullbar"
          BUILD_BIN=".build/release/$EXECUTABLE"
          DIST_DIR="dist"
          APP_DIR="$DIST_DIR/$APP_NAME"
          ICON_NAME="Pullbar.icns"

          mkdir -p "$APP_DIR/Contents/MacOS" "$APP_DIR/Contents/Resources"
          cp "$BUILD_BIN" "$APP_DIR/Contents/MacOS/$EXECUTABLE"
          chmod +x "$APP_DIR/Contents/MacOS/$EXECUTABLE"

          ICON_PLIST_ENTRY=""
          if [[ -f "Assets/AppIcon/$ICON_NAME" ]]; then
            cp "Assets/AppIcon/$ICON_NAME" "$APP_DIR/Contents/Resources/$ICON_NAME"
            ICON_PLIST_ENTRY=$'  <key>CFBundleIconFile</key>\n  <string>Pullbar</string>'
          fi

          cat > "$APP_DIR/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>Pullbar</string>
            <key>CFBundleDisplayName</key>
            <string>Pullbar</string>
            <key>CFBundleIdentifier</key>
            <string>com.pullbar.app</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.meta.outputs.tag }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>$EXECUTABLE</string>
          $ICON_PLIST_ENTRY
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>LSUIElement</key>
            <true/>
          </dict>
          </plist>
          EOF

          codesign --force --deep --sign - --timestamp=none "$APP_DIR"
          codesign --verify --deep --strict --verbose "$APP_DIR"

      - name: Create zip artifact
        id: artifact
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          artifact="Pullbar-${{ steps.meta.outputs.tag }}.app.zip"
          zip -r "$artifact" Pullbar.app
          shasum -a 256 "$artifact" > "${artifact}.sha256"
          echo "artifact=$artifact" >> "$GITHUB_OUTPUT"

      - name: Build release report
        shell: bash
        run: |
          set -euo pipefail
          cat > dist/RELEASE_REPORT.md <<EOF
          # Pullbar Release Report

          - Tag: \
            `${{ steps.meta.outputs.tag }}`
          - Target commitish: \
            `${{ steps.meta.outputs.target }}`
          - Commit SHA: \
            `${{ github.sha }}`
          - Trigger: \
            `${{ github.event_name }}`
          - Workflow run: \
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Artifacts

          - `${{ steps.artifact.outputs.artifact }}`
          - `${{ steps.artifact.outputs.artifact }}.sha256`
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pullbar-release-${{ steps.meta.outputs.tag }}
          path: |
            dist/${{ steps.artifact.outputs.artifact }}
            dist/${{ steps.artifact.outputs.artifact }}.sha256
            dist/RELEASE_REPORT.md
          if-no-files-found: error

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ steps.meta.outputs.target }}
          name: ${{ steps.meta.outputs.title }}
          draft: ${{ steps.meta.outputs.draft == 'true' }}
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}
          body: ${{ inputs.release_notes }}
          generate_release_notes: ${{ inputs.release_notes == '' || inputs.release_notes == null }}
          files: |
            dist/${{ steps.artifact.outputs.artifact }}
            dist/${{ steps.artifact.outputs.artifact }}.sha256
            dist/RELEASE_REPORT.md
