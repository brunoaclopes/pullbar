name: Release Artifact

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag override (e.g. v1.2.3). Leave empty to auto-bump."
        required: false
        type: string
      version_bump:
        description: "If tag is empty, choose semantic version bump"
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
      target_commitish:
        description: "Branch or commit SHA to tag/release"
        required: false
        default: "main"
        type: string
      release_name:
        description: "Release title (optional)"
        required: false
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        default: false
        type: boolean
      draft:
        description: "Create as draft"
        required: false
        default: false
        type: boolean
      release_notes:
        description: "Custom release notes (optional)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-release-artifact:
    if: github.event_name != 'workflow_dispatch' || github.actor == github.repository_owner
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Verify manual dispatch authorization
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_ACTOR}" != "${GITHUB_REPOSITORY_OWNER}" ]]; then
            echo "Manual dispatch is restricted to the repository owner."
            exit 1
          fi

      - name: Build release binary
        run: swift build -c release

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            target="${{ inputs.target_commitish }}"

            git fetch --tags --force

            input_tag="${{ inputs.tag }}"
            if [[ -n "$input_tag" ]]; then
              tag="$input_tag"
            else
              latest_tag=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)
              if [[ -z "$latest_tag" ]]; then
                major=0
                minor=0
                patch=0
              else
                version="${latest_tag#v}"
                IFS='.' read -r major minor patch <<< "$version"
              fi

              case "${{ inputs.version_bump }}" in
                major)
                  major=$((major + 1))
                  minor=0
                  patch=0
                  ;;
                minor)
                  minor=$((minor + 1))
                  patch=0
                  ;;
                patch)
                  patch=$((patch + 1))
                  ;;
              esac

              tag="v${major}.${minor}.${patch}"
            fi

            if [[ -n "${{ inputs.release_name }}" ]]; then
              title="${{ inputs.release_name }}"
            else
              title="Pullbar ${tag}"
            fi
            prerelease="${{ inputs.prerelease }}"
            draft="${{ inputs.draft }}"
          else
            tag="${GITHUB_REF_NAME}"
            target="${GITHUB_SHA}"
            title="Pullbar ${tag}"
            prerelease="false"
            draft="false"
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "target=${target}" >> "$GITHUB_OUTPUT"
          echo "title=${title}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${prerelease}" >> "$GITHUB_OUTPUT"
          echo "draft=${draft}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag (manual release)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.meta.outputs.tag }}"
          target="${{ steps.meta.outputs.target }}"

          if git ls-remote --tags origin "refs/tags/${tag}" | grep -q "refs/tags/${tag}$"; then
            echo "Tag ${tag} already exists on origin."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" "$target" -m "Release $tag"
          git push origin "$tag"

      - name: Bundle Pullbar.app
        shell: bash
        run: |
          set -euo pipefail

          APP_NAME="Pullbar.app"
          EXECUTABLE="Pullbar"
          BUILD_BIN=".build/release/$EXECUTABLE"
          DIST_DIR="dist"
          APP_DIR="$DIST_DIR/$APP_NAME"
          ICON_NAME="Pullbar.icns"

          mkdir -p "$APP_DIR/Contents/MacOS" "$APP_DIR/Contents/Resources"
          cp "$BUILD_BIN" "$APP_DIR/Contents/MacOS/$EXECUTABLE"
          chmod +x "$APP_DIR/Contents/MacOS/$EXECUTABLE"

          ICON_PLIST_ENTRY=""
          if [[ -f "Assets/AppIcon/$ICON_NAME" ]]; then
            cp "Assets/AppIcon/$ICON_NAME" "$APP_DIR/Contents/Resources/$ICON_NAME"
            ICON_PLIST_ENTRY=$'  <key>CFBundleIconFile</key>\n  <string>Pullbar</string>'
          fi

          cat > "$APP_DIR/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>Pullbar</string>
            <key>CFBundleDisplayName</key>
            <string>Pullbar</string>
            <key>CFBundleIdentifier</key>
            <string>com.pullbar.app</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.meta.outputs.tag }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleExecutable</key>
            <string>$EXECUTABLE</string>
          $ICON_PLIST_ENTRY
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>LSUIElement</key>
            <true/>
          </dict>
          </plist>
          EOF

          codesign --force --deep --sign - --timestamp=none "$APP_DIR"
          codesign --verify --deep --strict --verbose "$APP_DIR"

      - name: Create zip artifact
        id: artifact
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          artifact="Pullbar-${{ steps.meta.outputs.tag }}.app.zip"
          zip -r "$artifact" Pullbar.app
          shasum -a 256 "$artifact" > "${artifact}.sha256"
          echo "artifact=$artifact" >> "$GITHUB_OUTPUT"

      - name: Build release report
        shell: bash
        run: |
          set -euo pipefail
          cat > dist/RELEASE_REPORT.md <<EOF
          # Pullbar Release Report

          - Tag: \
            `${{ steps.meta.outputs.tag }}`
          - Target commitish: \
            `${{ steps.meta.outputs.target }}`
          - Commit SHA: \
            `${{ github.sha }}`
          - Trigger: \
            `${{ github.event_name }}`
          - Workflow run: \
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Artifacts

          - `${{ steps.artifact.outputs.artifact }}`
          - `${{ steps.artifact.outputs.artifact }}.sha256`
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pullbar-release-${{ steps.meta.outputs.tag }}
          path: |
            dist/${{ steps.artifact.outputs.artifact }}
            dist/${{ steps.artifact.outputs.artifact }}.sha256
            dist/RELEASE_REPORT.md
          if-no-files-found: error

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ steps.meta.outputs.target }}
          name: ${{ steps.meta.outputs.title }}
          draft: ${{ steps.meta.outputs.draft == 'true' }}
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}
          body: ${{ inputs.release_notes }}
          generate_release_notes: ${{ inputs.release_notes == '' || inputs.release_notes == null }}
          files: |
            dist/${{ steps.artifact.outputs.artifact }}
            dist/${{ steps.artifact.outputs.artifact }}.sha256
            dist/RELEASE_REPORT.md
